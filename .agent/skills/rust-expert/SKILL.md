---
name: rust-expert
version: 1.0.0
description: >
  Rust å¼€å‘æœ€ä½³å®è·µï¼ŒåŒ…æ‹¬é”™è¯¯å¤„ç†ã€å†…å­˜å®‰å…¨ã€æ¨¡å—åŒ–è®¾è®¡ã€‚
  é’ˆå¯¹ Tauri æ¡Œé¢åº”ç”¨åœºæ™¯ä¼˜åŒ–ã€‚
---

# ğŸ¦€ Rust Expert

## 1. ä¾èµ–ç®¡ç† (Dependency Governance)

### ğŸš¨ é«˜å±ä¾èµ–éš”ç¦»åŸåˆ™ (The "Autogen Isolation" Rule)

å¯¹äº**è‡ªåŠ¨ç”Ÿæˆ**ä¸”**ç‰ˆæœ¬ä¸ç¨³å®š**çš„åº“ï¼ˆå…¸å‹ä»£è¡¨ï¼š`windows-rs`ï¼‰ï¼Œ**ä¸¥ç¦**åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ç›´æ¥æ•£å¸ƒå…¶ç±»å‹ã€‚

- **è§¦å‘æ¡ä»¶**ï¼š
  - åº“æ˜¯ Autogenerated (å¦‚ win32metadata ç”Ÿæˆ)
  - åº“å¤„äº 0.x ç‰ˆæœ¬ä¸” API é¢‘ç¹å˜åŠ¨
  - é¡¹ç›®é‡åº¦ä¾èµ–è¯¥åº“ (å¦‚ GDI ç»˜å›¾)

- **æ‰§è¡Œè§„èŒƒ**ï¼š
  - **å»ºç«‹é˜²è…å±‚ (Anti-Corruption Layer)**ï¼šåˆ›å»ºä¸€ä¸ªä¸“é—¨çš„æ¨¡å—ï¼ˆå¦‚ `src/platform/win32_wrapper.rs`ï¼‰ã€‚
  - **ç‰©ç†éš”ç¦»**ï¼šæ‰€æœ‰çš„ `use windows::Win32::...` åªèƒ½å‡ºç°åœ¨è¿™ä¸ª Wrapper æ–‡ä»¶ä¸­ã€‚
  - **ç±»å‹é‡æ˜ å°„**ï¼šå¯¹å¤–æš´éœ²è‡ªå®šä¹‰çš„å®‰å…¨ç±»å‹ï¼ˆå¦‚ `pub struct SafeHDC(usize)`ï¼‰ï¼Œä¸šåŠ¡é€»è¾‘åªè®¤è¿™ä¸ª Wrapper ç±»å‹ã€‚

- **æ”¶ç›Š**ï¼šå½“ä¸Šæ¸¸åº“å‘ç”Ÿ Breaking Changeï¼ˆå¦‚ `HANDLE` ç±»å‹å˜æ›´ï¼‰æ—¶ï¼Œåªéœ€ä¿®æ”¹ Wrapper æ–‡ä»¶çš„ä¸€å¤„ä»£ç ï¼Œè€Œéå…¨é¡¹ç›®çš„å‡ ç™¾å¤„è°ƒç”¨ã€‚

---

## 2. ä»£ç ç»„ç»‡

### æ¨¡å—ç»“æ„

```rust
src/
â”œâ”€â”€ main.rs          // å…¥å£ï¼Œåªåšåˆå§‹åŒ–
â”œâ”€â”€ lib.rs           // å…¬å…±å¯¼å‡º
â”œâ”€â”€ commands/        // Tauri commands
â”œâ”€â”€ services/        // ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ models/          // æ•°æ®ç»“æ„
â””â”€â”€ utils/           // å·¥å…·å‡½æ•°
```

### è§„åˆ™

- âœ… æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€
- âœ… å…¬å…± API é€šè¿‡ `lib.rs` å¯¼å‡º
- âŒ ç¦æ­¢åœ¨ `main.rs` å†™ä¸šåŠ¡é€»è¾‘

---

## 2. é”™è¯¯å¤„ç†

### ä½¿ç”¨ `thiserror` + `anyhow`

```rust
// å®šä¹‰é”™è¯¯ç±»å‹
#[derive(thiserror::Error, Debug)]
pub enum AppError {
    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),
    #[error("Capture failed: {0}")]
    Capture(String),
}

// åœ¨å‡½æ•°ä¸­ä½¿ç”¨
fn capture() -> Result<(), AppError> {
    // ...
}
```

### è§„åˆ™

- âœ… æ°¸è¿œä½¿ç”¨ `Result<T, E>`ï¼Œä¸ç”¨ `unwrap()`
- âœ… åªåœ¨æµ‹è¯•æˆ–ç¡®å®šå®‰å…¨æ—¶ç”¨ `expect()`
- âŒ ç¦æ­¢ `panic!` åœ¨ç”Ÿäº§ä»£ç 

---

## 3. å¼‚æ­¥å¤„ç†

### Tokio æœ€ä½³å®è·µ

```rust
#[tokio::main]
async fn main() {
    // ä¸»çº¿ç¨‹åªåšè°ƒåº¦
}

// CPU å¯†é›†ä»»åŠ¡ç”¨ spawn_blocking
tokio::task::spawn_blocking(|| {
    heavy_computation();
}).await?;
```

### è§„åˆ™

- âœ… IO æ“ä½œç”¨ `async`
- âœ… CPU å¯†é›†ç”¨ `spawn_blocking`
- âŒ ç¦æ­¢åœ¨ async å‡½æ•°ä¸­é˜»å¡

---

## 4. å†…å­˜å®‰å…¨

### æ‰€æœ‰æƒæ£€æŸ¥æ¸…å•

- [ ] é¿å…ä¸å¿…è¦çš„ `clone()`
- [ ] ä¼˜å…ˆä½¿ç”¨ `&str` è€Œé `String`
- [ ] å¤§ç»“æ„ä½“ä¼ å¼•ç”¨ `&T`ï¼Œå°ç»“æ„ä½“ä¼ å€¼
- [ ] ä½¿ç”¨ `Arc<Mutex<T>>` è·¨çº¿ç¨‹å…±äº«

---

## 5. Tauri ç‰¹å®š

### Command å®šä¹‰

```rust
#[tauri::command]
async fn my_command(state: State<'_, AppState>) -> Result<String, String> {
    // ä¸šåŠ¡é€»è¾‘ä¸å†™è¿™é‡Œï¼Œè°ƒç”¨ service
    services::do_something(&state).await
        .map_err(|e| e.to_string())
}
```

### è§„åˆ™

- âœ… Command åªåšå‚æ•°è§£æå’Œè°ƒç”¨ service
- âœ… é”™è¯¯è½¬æ¢ä¸º `String` è¿”å›å‰ç«¯
- âŒ ç¦æ­¢åœ¨ command é‡Œå†™å¤æ‚é€»è¾‘
