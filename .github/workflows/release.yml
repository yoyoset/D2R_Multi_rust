name: Release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install Rclone (Chocolatey)
        run: choco install rclone

      - name: Configure Rclone
        shell: pwsh
        run: |
          $rcloneConfigDir = "$env:USERPROFILE\.config\rclone"
          if (!(Test-Path $rcloneConfigDir)) { New-Item -ItemType Directory -Force -Path $rcloneConfigDir }
          $rcloneConf = "$rcloneConfigDir\rclone.conf"
          
          $configContent = @"
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
          acl = private
          no_check_bucket = true
          "@
          
          Set-Content -Path $rcloneConf -Value $configContent

      - name: Install dependencies (npm)
        run: npm ci

      - name: Build the app
        uses: tauri-apps/tauri-action@dev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          args: --target x86_64-pc-windows-msvc

      - name: Prepare Artifacts for R2
        shell: pwsh
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          $dist = "dist_r2"
          if (!(Test-Path $dist)) { New-Item -ItemType Directory -Force -Path $dist }
          
          # Root of build artifacts
          $buildDir = "src-tauri/target/x86_64-pc-windows-msvc/release/bundle"
          if (!(Test-Path $buildDir)) { $buildDir = "src-tauri/target/release/bundle" }
          
          Write-Host "Searching for artifacts in: $buildDir"
          Get-ChildItem -Path $buildDir -Recurse

          # 1. Installer (Main EXE for user download)
          $exeFile = Get-ChildItem -Path $buildDir -Filter "*setup.exe" -Recurse | Select-Object -First 1
          if ($exeFile) { 
              Copy-Item $exeFile.FullName "$dist/d2r-rust_${version}_x64-setup.exe"
              Write-Host "Found Installer: $($exeFile.Name)"
          }

          # 2. Portable (Zip)
          $rawExe = Get-ChildItem -Path "src-tauri/target" -Filter "d2r-rust.exe" -Recurse | Where-Object { $_.FullName -like "*release*" } | Select-Object -First 1
          if ($rawExe) {
            Compress-Archive -Path $rawExe.FullName -DestinationPath "$dist/d2r-rust_${version}_x64-portable.zip" -Force
            Write-Host "Created Portable: d2r-rust_${version}_x64-portable.zip"
          }
          
          # 3. Signature & Updater Package
          # We look for ANY .sig file and its corresponding data file
          Write-Host "Searching for signatures..."
          $sigFile = Get-ChildItem -Path $buildDir -Filter "*.sig" -Recurse | Select-Object -First 1

          if ($sigFile) {
             $sig = (Get-Content $sigFile.FullName -Raw).Trim()
             Write-Host "Found signature in: $($sigFile.FullName)"
             
             $dataFileFullPath = $sigFile.FullName.Replace(".sig", "")
             $dataFileName = [System.IO.Path]::GetFileName($dataFileFullPath)
             
             # Final update file name for R2
             $targetUpdateName = "d2r-rust_${version}_x64-setup.update"
             if ($dataFileName.EndsWith(".zip")) { $targetUpdateName += ".zip" }
             elseif ($dataFileName.EndsWith(".exe")) { $targetUpdateName += ".exe" }
             else { $targetUpdateName += [System.IO.Path]::GetExtension($dataFileName) }
             
             Write-Host "Mapping $dataFileName to $targetUpdateName"
             Copy-Item $dataFileFullPath "$dist/$targetUpdateName"

             $json = @{
                version = $version
                notes = "Update v$version"
                pub_date = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
                platforms = @{
                    "windows-x86_64" = @{
                        signature = $sig
                        url = "https://update.squareuncle.com/d2r-rust/$targetUpdateName"
                    }
                }
             }
             $json | ConvertTo-Json -Depth 5 | Out-File "$dist/latest.json" -Encoding utf8
          } else {
             Write-Warning "No signature found in bundle dir. Searching workspace..."
             $sigFile = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "*.sig" -Recurse | Select-Object -First 1
             if ($sigFile) {
                # Repeat logic for workspace sig
                $sig = (Get-Content $sigFile.FullName -Raw).Trim()
                $dataFileFullPath = $sigFile.FullName.Replace(".sig", "")
                $targetUpdateName = "d2r-rust_${version}_x64-setup.update" + [System.IO.Path]::GetExtension($dataFileFullPath)
                Copy-Item $dataFileFullPath "$dist/$targetUpdateName"
                # (JSON generation same as above)
                $json = @{
                   version = $version
                   notes = "Update v$version"
                   pub_date = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
                   platforms = @{ "windows-x86_64" = @{ signature = $sig; url = "https://update.squareuncle.com/d2r-rust/$targetUpdateName" } }
                }
                $json | ConvertTo-Json -Depth 5 | Out-File "$dist/latest.json" -Encoding utf8
             } else {
                Write-Error "CRITICAL: No valid .sig file found anywhere. Build failed to sign."
                exit 1
             }
          }
          
          if ("${{ github.ref_type }}" -eq "tag") {
              Write-Host "Uploading to Release: ${{ github.ref_name }}"
              gh release upload ${{ github.ref_name }} (Get-ChildItem "$dist/*" | Select-Object -ExpandProperty FullName) --clobber
          }

      - name: Upload to Cloudflare R2
        shell: pwsh
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          rclone copy dist_r2 r2:d2r-rust-updates/d2r-rust --progress --s3-no-check-bucket
          # Maintain 'latest' alias for manual downloads
          rclone copyto "dist_r2/d2r-rust_${version}_x64-setup.exe" "r2:d2r-rust-updates/d2r-rust/d2r-rust_latest_x64-setup.exe" --s3-no-check-bucket
          rclone copyto "dist_r2/d2r-rust_${version}_x64-portable.zip" "r2:d2r-rust-updates/d2r-rust/d2r-rust_latest_x64-portable.zip" --s3-no-check-bucket
