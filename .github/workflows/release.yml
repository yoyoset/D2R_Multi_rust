name: Release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (frontend)
        run: pnpm install

      - name: Setup rclone
        uses: animin/setup-rclone@v1
        with:
          rclone_config: |
            [r2]
            type = s3
            provider = Cloudflare
            access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
            secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
            endpoint = https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
            acl = private

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'D2R-Rust v__VERSION__'
          releaseBody: 'See CHANGELOG.md for details.'
          releaseDraft: true
          prerelease: false

      - name: Prepare Artifacts for R2
        shell: powershell
        run: |
          $version = "${{ github.ref_name }}".Substring(1)
          $dist = "dist_r2"
          New-Item -ItemType Directory -Force -Path $dist
          
          # 1. Installer (.exe)
          $exeSource = "src-tauri/target/release/bundle/nsis/d2r-rust_${version}_x64-setup.exe"
          $exeDest = "$dist/d2r-rust_${version}_x64-setup.exe"
          
          if (Test-Path $exeSource) {
            Copy-Item $exeSource $exeDest
            Write-Host "Copied EXE to $exeDest"
          } else {
            Write-Error "EXE not found at $exeSource"
          }

          # 2. Portable (.zip) - We create it from the raw exe
          $rawExe = "src-tauri/target/release/d2r-rust.exe"
          $zipDest = "$dist/d2r-rust_${version}_x64-portable.zip"
          
          if (Test-Path $rawExe) {
            Compress-Archive -Path $rawExe -DestinationPath $zipDest
            Write-Host "Created Portable ZIP at $zipDest"
          } else {
             Write-Error "Raw EXE not found at $rawExe"
          }
          
          # 3. Signature File (.sig) - Extract from latest.json or .sig file generated by tauri-action?
          $sigSource = "src-tauri/target/release/bundle/nsis/d2r-rust_${version}_x64_en-US.nsis.zip.sig"
          if (Test-Path $sigSource) {
             $sig = Get-Content $sigSource
             Write-Host "Signature found: $sig"
             
             # Generate latest.json for R2
             $json = @{
                version = $version
                notes = "Update v$version"
                pub_date = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")
                platforms = @{
                    "windows-x86_64" = @{
                        signature = $sig
                        url = "https://update.squareuncle.com/d2r-rust/d2r-rust_${version}_x64-setup.exe"
                    }
                }
             }
             # Convert to JSON with UTF8 encoding
             $json | ConvertTo-Json -Depth 5 | Out-File "$dist/latest.json" -Encoding utf8
             Write-Host "Generated latest.json"
          } else {
             Write-Warning "Signature file not found, latest.json will NOT be generated."
          }

      - name: Upload to Cloudflare R2
        shell: powershell
        run: |
          # Copy dist folder to R2 bucket root folder (d2r-rust-updates/d2r-rust)
          # Assuming BUCKET structure is like in publish.ps1: d2r-rust-updates/d2r-rust/...
          
          # rclone copy source destination
          rclone copy dist_r2 r2:d2r-rust-updates/d2r-rust --progress
          
          # Create "latest" copies for the website download buttons
          $version = "${{ github.ref_name }}".Substring(1)
          
          rclone copyto "dist_r2/d2r-rust_${version}_x64-setup.exe" "r2:d2r-rust-updates/d2r-rust/d2r-rust_latest_x64-setup.exe"
          rclone copyto "dist_r2/d2r-rust_${version}_x64-portable.zip" "r2:d2r-rust-updates/d2r-rust/d2r-rust_latest_x64-portable.zip"
